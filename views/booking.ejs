<!DOCTYPE html>
<html lang="en-HK">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="<%= csrfToken %>">
    <title>Car Booking - CarRental</title>
    <link rel="stylesheet" href="stylesheets/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<style>
    .page-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        padding: 20px;
    }

    .left-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 1200px;
    }

    .right-column {
        position: relative;
    }

    .booking-summary {
        position: sticky;
        top: 80px;
        max-width: 320px;
    }

    .car-description.collapsed {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .car-description.expanded {
        display: block;
    }

    .expand-btn {
        background: none;
        border: none;
        color: var(--color-primary);
        cursor: pointer;
        font-size: var(--font-size-sm);
        padding: var(--space-4) 0;
    }
</style>

<body>
    <nav class="navbar">
        <a href="/" class="logo">carRental</a>
        <ul class="nav-links">
            <li><a href="/">Home</a></li>
            <li><a href="/cars">Car List</a></li>
            <% if (currentUser) { %>
                <li><a href="/users/profile/<%= currentUserName %>">Profile</a></li>
                <li class="user-menu">
                    <span class="user-name">Hello, <%= currentUserName %>!</span>
                    <form action="/users/logout" method="post" class="logout-form">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit" class="logout-button">Logout</button>
                    </form>
                </li>
                <% } else { %>
                    <li class="user-menu">
                        <a href="/users/login?returnUrl=/booking?carID=<%= car.carID %>">
                            <i class="fas fa-user">Login</i>
                        </a>
                    </li>
                    <% } %>
        </ul>
    </nav>

    <div class="page-container">
        <div class="left-column">
            <section class="selected-car">
                <div class="car-card">
                    <img src="<%= car.imageURL %>" class="car-image" onerror="this.src='/images/default-car.jpg'">
                    <div class="car-info">
                        <div class="car-title">
                            <span id="carBrand">
                                <%=car.brand%>
                            </span>
                            <%= car.model %>
                        </div>
                        <div class="car-year">
                            <%= car.year %> Year
                        </div>
                        <div class="car-description" id="carDescription">
                            <%= car.description %>
                        </div>
                        <button type="button" class="expand-btn" id="expandBtn" onclick="toggleDescription()">
                            Show More
                        </button>
                        <div class="car-details">
                            <div><strong>Type:</strong>
                                <%= car.type %>
                            </div>
                            <div><strong>Seats:</strong>
                                <%= car.seats %>
                            </div>
                            <div><strong>Transmission:</strong>
                                <%= car.transmission %>
                            </div>
                            <div><strong>Power Source:</strong>
                                <%= car.powerSource %>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div class="booking-container">
                <div class="booking-grid">
                    <div class="booking-form-section">
                        <h1>Booking Form</h1>
                        <% if(currentUserName){ %>
                            <form class="booking-form" id="bookingForm" action="/payment" method="get">
                                <div class="form-group">
                                    <label for="name">Name</label>
                                    <input type="text" id="name" name="userName" value="<%= currentUserName %>"
                                        required>
                                </div>

                                <div class="form-group">
                                    <label for="phone">Phone</label>
                                    <input type="tel" id="phone" name="phone" value="<%=user?user.phone:''%>"
                                        pattern="(\d{8}|\d{11})" placeholder="Enter 8 or 11 Numbers" maxlength="11" readonly>
                                    <div class="error-message" id="phoneError"></div>
                                </div>

                                <div class="date-range-picker">
                                    <div class="form-group">
                                        <label for="date-range">Select Rental Dates</label>
                                        <input type="text" id="date-range" name="date-range" placeholder="Select start and end dates"
                                            readonly required>
                                        <input type="hidden" id="startdate" name="startDate">
                                        <input type="hidden" id="enddate" name="endDate">
                                        <div class="error-message" id="dateError"></div>
                                    </div>
                                </div>

                                <input type="hidden" id="carID" name="carID" value="<%=car.carID%>">
                                <input type="hidden" id="amount" name="amount" value="0">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button type="submit" class="submit-button" id="submitBtn" disabled>Confirm Booking</button>
                            </form>
                            <p class="error-message" id="generalError"></p>
                            <%}else{%>
                                <p>Please <a href="/users/login?returnUrl=/booking?carID=<%= car.carID %>">Login</a>
                                </p>
                                <%}%>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-column">
            <div class="booking-summary">
                <h2>Booking Summary</h2>
                <div class="car-title">
                    <span>
                        <%=car.brand%>
                    </span>
                    <%= car.model %>
                        <div class="rental-details">
                            <div class="detail-item">
                                <span>Rental Days:</span>
                                <span id="totalDays">0 Day</span>
                            </div>
                            <div class="detail-item">
                                <span>Daily Rate:</span>
                                <span id="dailyRate">$<%= car.dailyRate %></span>
                            </div>
                            <div class="detail-item total">
                                <span>Total Amount:</span>
                                <span id="totalAmount">$0</span>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 CarRental. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        const phoneInput = document.getElementById('phone');
        const dateRangeInput = document.getElementById('date-range');
        const submitBtn = document.getElementById('submitBtn');
        const phoneError = document.getElementById('phoneError');
        const dateError = document.getElementById('dateError');
        const generalError = document.getElementById('generalError');

        // 验证手机号
        function validatePhone() {
            const phone = phoneInput.value.trim();
            // 修改正则表达式：只允许8位或11位数字
            const phoneRegex = /^(\d{8}|\d{11})$/;

            phoneError.style.display = 'none';
            phoneInput.parentElement.classList.remove('error');

            if (!phone) {
                showPhoneError('Please enter your phone number');
                return false;
            }

            if (!phoneRegex.test(phone)) {
                showPhoneError('Phone number must be 8 or 11 digits');
                return false;
            }

            return true;
        }

        // 验证日期
        function validateDates() {
            const startDate = document.getElementById('startdate').value;
            const endDate = document.getElementById('enddate').value;

            dateError.style.display = 'none';
            dateRangeInput.parentElement.classList.remove('error');

            if (!startDate || !endDate) {
                showDateError('Please select rental dates');
                return false;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            if (daysDiff > 30) {
                showDateError('Rental period cannot exceed 30 days');
                return false;
            }

            return true;
        }

        function showPhoneError(message) {
            phoneError.textContent = message;
            phoneError.style.display = 'block';
            phoneInput.parentElement.classList.add('error');
        }

        function showDateError(message) {
            dateError.textContent = message;
            dateError.style.display = 'block';
            dateRangeInput.parentElement.classList.add('error');
        }

        function showGeneralError(message) {
            generalError.textContent = message;
            generalError.style.display = 'block';
        }

        // 检查表单完整性
        function checkFormValidity() {
            const phoneValid = validatePhone();
            const dateValid = validateDates();
            submitBtn.disabled = !(phoneValid && dateValid);
        }

        // 计算总金额
        function calculateTotal() {
            const startDate = document.getElementById('startdate').value;
            const endDate = document.getElementById('enddate').value;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                const dailyRate = <%= car.dailyRate %>;
                const total = days * dailyRate;

                document.getElementById('totalDays').textContent = `${days} Day${days > 1 ? 's' : ''}`;
                document.getElementById('totalAmount').textContent = `$${total}`;
                document.getElementById('amount').value = total;
            }
        }

        // 事件监听
        phoneInput.addEventListener('input', checkFormValidity);
        phoneInput.addEventListener('blur', validatePhone);

        // 初始化 flatpickr
        flatpickr("#date-range", {
            mode: "range",
            minDate: "today",
            maxDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000), // 最多90天后
            dateFormat: "Y-m-d",
            disableMobile: true,
            locale: {
                rangeSeparator: " to ",
                firstDayOfWeek: 1,
                weekdays: {
                    shorthand: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                    longhand: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
                }
            },
            onChange: function (selectedDates, dateString, instance) {
                if (selectedDates.length === 2) {
                    document.getElementById('startdate').value = selectedDates[0].toISOString().split('T')[0];
                    document.getElementById('enddate').value = selectedDates[1].toISOString().split('T')[0];
                    calculateTotal();
                    checkFormValidity();
                }
            }
        });

        // 表单提交验证
        document.getElementById('bookingForm').addEventListener('submit', function (e) {
            generalError.style.display = 'none';

            if (!validatePhone() || !validateDates()) {
                e.preventDefault();
                showGeneralError('Please check and correct errors in the form');
                return false;
            }

            // 最终检查金额
            const amount = document.getElementById('amount').value;
            if (!amount || amount <= 0) {
                e.preventDefault();
                showGeneralError('Please select valid rental dates');
                return false;
            }
        });

        function toggleDescription() {
            const description = document.getElementById('carDescription');
            const btn = document.getElementById('expandBtn');

            if (description.classList.contains('collapsed')) {
                description.classList.remove('collapsed');
                description.classList.add('expanded');
                btn.textContent = 'Show Less';
            } else {
                description.classList.remove('expanded');
                description.classList.add('collapsed');
                btn.textContent = 'Show More';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const description = document.getElementById('carDescription');
            description.classList.add('collapsed');
            checkFormValidity();
        });
    </script>
</body>

</html>